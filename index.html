<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]>      <html class="no-js"> <!--<![endif]-->
<html lang="en">
  <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <title></title>
      <meta name="description" content="">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <link rel="stylesheet" href="style.css">
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
      <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script> -->
    </head>
  <body>
      <!--[if lt IE 7]>
          <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="#">upgrade your browser</a> to improve your experience.</p>
      <![endif]-->
      <div class="container">
        <div class="col-1 offset-11">
          <button id="lang-vi" class="btn">VI</button>
          <button id="lang-en" class="btn">EN</button>
        </div>
      </div>
      <section id="presentation" class="container mb-3">
        <div class="row">
          <div id="draw-area" class="col-12 col-xxl-6">
            <div class="row">
              <div class="col-12">
                <h2 data-translate="area-draw-title">Draw Area</h2>
              </div>
            </div>
            <div class="row">
                <canvas id="canvas" width="636" height="550"></canvas>
            </div>
            <p class="fst-italic" data-translate="area-draw-notice">(Hold Shift to move around)</p>
          </div>
          <div id="render-area" class="col-12 col-xxl-6">
            <div class="row">
              <div class="col-12">
                <h2 data-translate="area-render-title">Render Area</h2>
              </div>
            </div>
            <div class="row">
              <div class="col-12">
                <img id="canvas-img" class="" src="OIG4.jpg" alt="Image from canvas, check render to automate transfrom canvas to image" >
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="action" class="container mb-3">
        <div class="row mb-3">
          <label for="" data-translate="input-label">Input configuration</label>
          <div class="col-6 col-lg-3">
            <!-- <label for="excelFile">Input file data</label> -->
            <input type="file" id="excelFile" class="form-control" title="Input file data"/>
          </div>
          <div class="col-6 col-lg-3 mb-1">
            <div class="input-group">
              <label for="sheet-name-selector" class="input-group-text col-6 col-xl-4" data-translate="input-sheetname-label">Sheet name</label>
              <!-- <input type="text" id="sheet-name" class="form-control" value="Requirements" placeholder="Name of the sheet contain use-cases's name. Example: Requirements"/> -->
              <select name="" id="sheet-name-selector" class="form-control" title="Name of the sheet contain use-cases's name. Example: Requirements">
              </select>
            </div>
          </div>
          <div class="col-6 col-lg-3 mb-1">
            <div class="input-group">
              <label for="start-cell" class="input-group-text col-6 col-xl-4" data-translate="input-startcell-label">Start cell</label>
              <input type="text" id="start-cell" class="form-control" value="B2" title="Example: B2 (column B, row 2)" placeholder="Example: B2 (column B, row 2)"/>
            </div>            
          </div>
          <div class="col-6 col-lg-3 mb-1">
            <div class="input-group">
              <label for="end-cell" class="input-group-text col-6 col-xl-4" data-translate="input-endcell-label">End cell</label>
              <input type="text" id="end-cell" class="form-control" value="D" title="Example: D (to the last row of column D)" placeholder="Example: D (to the last row of column D)"/>
            </div>
          </div>
          <div class="col-6 col-lg-3 mb-1">
            <div class="input-group">
              <label for="id-col" class="input-group-text col-6 col-lg-8" data-translate="input-idcol-label">Index column</label>
              <input type="number" id="id-col" class="form-control" value="0" title="Index of column in [Start cell:End cell] table. Example: table [B2:DD], index of column B is 0, index of column C is 1"/>
            </div>            
          </div>
          <div class="col-6 col-lg-3 mb-1">
            <div class="input-group">
              <label for="name-col" class="input-group-text col-6 col-lg-8" data-translate="input-namecol-label">Use case text column</label>
              <input type="number" id="name-col" class="form-control" value="1" title="Index of column in [Start cell:End cell] table. Example: table [B2:DD], index of column B is 0, index of column D is 2"/>
            </div>
          </div>
          <div class="col-6 col-lg-3 mb-1">
            <div class="input-group">
              <label for="actor-col" class="input-group-text col-6 col-lg-8" data-translate="input-actorcol-label">Actor column</label>
              <input type="number" id="actor-col" class="form-control" value="2" title="Index of column in [Start cell:End cell] table. Example: table [B2:DD], index of column B is 0, index of column D is 2"/>
            </div>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-6 col-lg-3">
            <div class="input-group">
              <label for="from" class="input-group-text col-6 col-lg-8" data-translate="input-from-label">From</label>
              <input type="number" name="" id="from" value="1" class="form-control">
            </div>
          </div>
          <div class="col-6 col-lg-3">
            <div class="input-group">
              <label for="to" class="input-group-text col-6 col-lg-8" data-translate="input-to-label">To</label>
              <input type="number" name="" id="to" value="8" class="form-control">
            </div>
          </div>
          <div class="col-6 col-lg-3">
            <div class="input-group">
              <label for="uc-per-pic" class="input-group-text col-6 col-lg-8" data-translate="input-uc-per-pic-label">Usecase per picture</label>
              <input type="number" name="" id="uc-per-pic" value="8" class="form-control">
            </div>
          </div>
          <div class="col-6 col-lg-3">
            <!-- <label for="">Current draw: <span id="current-draw">0</span></label> -->
            <div class="input-group">
              <label for="current-draw" class="input-group-text col-6 col-lg-8" data-translate="input-current-draw-label">Current draw</label>
              <input type="text" disabled name="" id="current-draw" value="0" class="form-control">
            </div>

          </div>
        </div>
        <div class="row mb-3">
          <div class="col-4">
            <button id="draw" class="btn btn-primary" data-translate="input-btn-draw">Draw</button>
            <button id="draw-next" class="btn btn-secondary" data-from="" data-to="" data-translate="input-btn-draw-next">Draw next</button>
            <button id="draw-prev" class="btn btn-secondary" data-from="" data-to="" data-translate="input-btn-draw-prev">Draw previous</button>
          </div>
          <div class="col-4">
            <div class="input-group mb-3">
              <button id="render" class="btn btn-info" data-translate="input-btn-render">Render</button>
              <div class="input-group-text">
                <input id="chk-render-direct" class="form-check-input mt-0" type="checkbox" value="" aria-label="Checkbox for following text input">
              </div>
            </div>
            
          </div>
          <div class="col-4">
            <button id="render" class="btn btn-secondary" data-translate="input-btn-export">Export</button>
          </div>
        </div>
      </section>
      <section id="configuration" class="container mb-3">
        <div class="row">
          <div id="uc-size" class="col-12 col-lg-6">
            <label for="uc-size" data-translate="uc-title">Use-case Size</label>
            <div class="input-group">
              <label for="uc-width" class="input-group-text col-5" data-translate="uc-width">Use-case Width</label>
              <input type="number" name="" id="uc-width" value="200" class="form-control">
            </div>
            <div class="input-group">
              <label for="uc-height" class="input-group-text col-5" data-translate="uc-height">Use-case Height</label>
              <input type="number" name="" id="uc-height" value="40" class="form-control">
            </div>
            <div class="input-group">
              <label for="uc-distance" class="input-group-text col-5" data-translate="uc-distance">Distance between 2 UC</label>
              <input type="number" name="" id="uc-distance" value="20" class="form-control">
            </div>
            <div class="input-group">
              <label for="uc-person-distance" class="input-group-text col-5" data-translate="uc-person-distance">Distance between UC and person</label>
              <input type="number" name="" id="uc-person-distance" value="100" class="form-control">
            </div>
          </div>
          <div id="uc-shape" class="col-12 col-lg-6">
            <div id="uc-shape">
              <label for="uc-shape-selector" data-translate="uc-shape-selector">Use-case shape</label>
              <div class="input-group">
                <select name="" id="uc-shape-selector" class="form-control">
                  <option value="rectangle" data-translate="uc-shape-selector-rectangle">Rectangle</option>
                  <option value="ellipse" data-translate="uc-shape-selector-ellipse">Ellipse</option>
                </select>
              </div>
            </div>
            <div id="person-shape">
              <label for="person-shape-selector" data-translate="person-shape-selector">Person shape</label>
              <div class="input-group">
                <select name="" id="person-shape-selector" class="form-control">
                  <option value="thin" data-translate="person-shape-selector-thin">Thin body</option>
                  <option value="bigger" data-translate="person-shape-selector-bigger">Bigger body</option>
                </select>
              </div>
            </div>
          </div>
        </div>


        <div id="left-right-layout" class="col-12">
          <label for="left-right-layout" data-translate="left-right-layout">Left-Right Layout</label>
          <select name="" id="left-right-layout-selector" class="form-control">
            <option value="left" data-translate="left-right-layout-selector-left">Left side</option>
            <option value="right" data-translate="left-right-layout-selector-right">Right side</option>
            <option value="both" selected data-translate="left-right-layout-selector-both">Both side</option>
          </select>
        </div>
        <div id="render-layout" class="col-12">
          <label for="render-layout" data-translate="render-layout">Render Layout</label>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" value="" id="chkRenderObjectOnly" checked>
            <label class="form-check-label" for="chkRenderObjectOnly" data-translate="render-layout-label">
              Only render the objects area in canvas
            </label>
          </div>
        </div>
      </section>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/4.5.0/fabric.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" integrity="sha512-r22gChDnGvBylk90+2e/ycr3RVrDi8DIOkIGNhJlKfuyQM4tIRAI062MaV8sfjQKYVGjOBaZBOA87z+IhZE9DA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="lang.js"></script>
<script src="app.js"></script>
<script>
  var originalFontSize = 14;
  var panning = false;
  var lastPosX = 0;
  var lastPosY = 0;
  let workbook = null;
  const canvas = new fabric.Canvas('canvas');

  canvas.on('mouse:down', function (e) {
      if (e.e.shiftKey) {
          panning = true;
          lastPosX = e.e.clientX;
          lastPosY = e.e.clientY;
      }
  });

  canvas.on('mouse:move', function (e) {
      if (panning && e.e.shiftKey) {
          var delta = new fabric.Point(e.e.clientX - lastPosX, e.e.clientY - lastPosY);
          canvas.relativePan(delta);
          lastPosX = e.e.clientX;
          lastPosY = e.e.clientY;
          console.log(canvas.width, canvas.height);
      }
      
  });

  canvas.on('mouse:up', function (e) {
      panning = false;
      lastPosX = 0;
      lastPosY = 0;
  });

  function resizeCanvas() {    
    canvas.setWidth(document.getElementById('draw-area').offsetWidth);
    canvas.setHeight(document.getElementById('draw-area').offsetHeight);
    canvas.renderAll();
  }

  // Call resizeCanvas at the start and whenever the window is resized
  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);

  document.getElementById('excelFile').addEventListener('change', function(e) {
    var reader = new FileReader();
    reader.onload = function(e) {
      var data = new Uint8Array(e.target.result);
      var wb = XLSX.read(data, {type: 'array'});

      // Get the first worksheet
      document.getElementById('sheet-name-selector').innerHTML = '';
      var sheet_name_list = wb.SheetNames;
      sheet_name_list.forEach((name) => {
        document.getElementById('sheet-name-selector').innerHTML += `<option value="${name}" ${name == "Use Case" ? "selected": ""}>${name}</option>`;
      });
      // var worksheet = workbook.Sheets[sheet_name_list[0]];
      workbook = wb;
    };
    reader.readAsArrayBuffer(this.files[0]);
  }, false);

  function WorkbookRead(_workbook){
    // var worksheet = workbook.Sheets['Requirements'];
    var worksheet = _workbook.Sheets[document.getElementById('sheet-name-selector').value];

    // // Convert the worksheet to JSON
    // var data = XLSX.utils.sheet_to_json(worksheet);
    
    // Get the range of cells for the table
    var startCell = document.getElementById('start-cell').value;
    var endCell = document.getElementById('end-cell').value + worksheet['!ref'].split(':')[1].replace(/[A-Z]/g, ''); // Get the last row number of column D
    var range = XLSX.utils.decode_range(startCell + ':' + endCell);

    // Get the cells in the range
    var tableData = [];
    for(var R = range.s.r; R <= range.e.r; ++R) {
      var rowData = [];
      for(var C = range.s.c; C <= range.e.c; ++C) {
        var cell_address = {c:C, r:R};
        var cell_ref = XLSX.utils.encode_cell(cell_address);
        if(worksheet[cell_ref]) {
          rowData.push(worksheet[cell_ref].v);
        } else {
          rowData.push(null);
        }
      }
      tableData.push(rowData);
    }
    
    const lst = tableData.filter((item) => {
      return item[0] !== null && !isNaN(item[0]) && item[0] !== '';
    }).map((item) => {        
        return {
          id: item[document.getElementById('id-col').value],
          name: item[document.getElementById('name-col').value],
          actor: item[document.getElementById('actor-col').value],
        };
      return;
    });
    
    app.options = {
      originalFontSize: 16,
      _data: lst,
      _drawArea: canvas,
      drawButton: {
        btnDrawStart: 'draw',
        btnDrawNext: 'draw-next',
        btnDrawPrev: 'draw-prev',
        showDrawCurrent: 'current-draw',
      },
      useCase: {
        size: {
          width: parseInt(document.getElementById("uc-width").value),
          height: parseInt(document.getElementById("uc-height").value),
          distance: parseInt(document.getElementById("uc-distance").value),
          useCasePersonDistance: parseInt(document.getElementById("uc-person-distance").value),
        },
        shape: document.getElementById("uc-shape-selector").value,
        ucPerPic: parseInt(document.getElementById("uc-per-pic").value),
      },
      person: {
        shape: document.getElementById("person-shape-selector").value,
      },
      layout: document.getElementById("left-right-layout-selector").value,
    };
    app.init();
  }
  document.getElementById('draw').addEventListener('click',() => {
    WorkbookRead(workbook);
    const from = parseInt(document.getElementById('from').value) - 1;
    const to = document.getElementById('to').value;
    // app.start();
    app.draw(from, to);
    if (document.getElementById('chk-render-direct').checked){
      document.getElementById('render').click();
    }
  });
  
  document.getElementById('draw-next').addEventListener('click',() => {
    const fromNext = event.target.dataset.from;
    const toNext = event.target.dataset.to;
    app.draw(fromNext, toNext);
    if (document.getElementById('chk-render-direct').checked){
      document.getElementById('render').click();
    }
  });
  
  document.getElementById('draw-prev').addEventListener('click',() => {
    const fromPrev = event.target.dataset.from;
    const toPrev = event.target.dataset.to;
    app.draw(fromPrev, toPrev);
    if (document.getElementById('chk-render-direct').checked){
      document.getElementById('render').click();
    }
  });

  document.getElementById('render').addEventListener('click',() => {
    if (document.getElementById('chkRenderObjectOnly').checked){
      var objects = canvas.getObjects();
      var minLeft = Infinity;
      var minTop = Infinity;
      var maxLeft = -Infinity;
      var maxTop = -Infinity;

      objects.forEach(function(obj) {
          var boundingRect = obj.getBoundingRect();
          minLeft = Math.min(minLeft, boundingRect.left);
          minTop = Math.min(minTop, boundingRect.top);
          maxLeft = Math.max(maxLeft, boundingRect.left + boundingRect.width);
          maxTop = Math.max(maxTop, boundingRect.top + boundingRect.height);
      });

      var boundingRect = {
          left: minLeft,
          top: minTop,
          width: maxLeft - minLeft,
          height: maxTop - minTop
      };
      // Convert the bounding rect to a data URL
      var dataURL = canvas.toDataURLWithCropping({
          format: 'png',
          quality: 1,
          left: boundingRect.left,
          top: boundingRect.top,
          width: boundingRect.width,
          height: boundingRect.height
      });
      
      var imgElement = document.getElementById('canvas-img');    
      imgElement.src = dataURL;
    } else {
      var dataURL = canvas.toDataURL({
        format: 'png',
        quality: 1
      });
      var imgElement = document.getElementById('canvas-img');    
      imgElement.src = dataURL;
    }
  });
  
  document.getElementById('uc-shape-selector').addEventListener('change', () => {
    app.options.useCase.shape = document.getElementById('uc-shape-selector').value;
  });

  document.getElementById('person-shape-selector').addEventListener('change', () => {
    app.options.person.shape = document.getElementById('person-shape-selector').value;
  });

  document.getElementById("uc-width").addEventListener('change', () => {
    app.options.useCase.size.width = parseInt(document.getElementById("uc-width").value);
  });

  document.getElementById("uc-height").addEventListener('change', () => {
    app.options.useCase.size.height = parseInt(document.getElementById("uc-height").value);
  });

  document.getElementById("uc-distance").addEventListener('change', () => {
    app.options.useCase.size.distance = parseInt(document.getElementById("uc-distance").value);
  });

  document.getElementById("uc-person-distance").addEventListener('change', () => {
    app.options.useCase.size.useCasePersonDistance = parseInt(document.getElementById("uc-person-distance").value);
  });

  document.getElementById('left-right-layout-selector').addEventListener('change', () => {
    app.options.layout = document.getElementById('left-right-layout-selector').value;
  });

  document.getElementById("uc-per-pic").addEventListener('change', () => {
    app.options.useCase.ucPerPic = parseInt(document.getElementById("uc-per-pic").value);
  });

  document.getElementById('lang-vi').addEventListener('click', () => {
    changeLanguage('vi');
  });

  document.getElementById('lang-en').addEventListener('click', () => {
    changeLanguage('en');
  });

  fabric.Canvas.prototype.toDataURLWithCropping = function (options) {
    var left = options.left,
        top = options.top,
        width = options.width,
        height = options.height;

    var data = this.contextContainer.getImageData(left, top, width, height);

    var tmpCanvas = document.createElement('canvas');
    tmpCanvas.width = width;
    tmpCanvas.height = height;

    var tmpCtx = tmpCanvas.getContext('2d');
    tmpCtx.putImageData(data, 0, 0);

    return tmpCanvas.toDataURL(options.format, options.quality);
  };
</script>
  </body>
</html>